# ugo Arm 監視・制御仕様

本ドキュメントは `ugo_arm_controller_specs.pdf` および `ugo_arm_monitor.py` に基づき、ugo Controller MCU を用いた ugo Arm の状態監視と制御に必要な要件を整理したものです。通信回線は ugo Controller MCU から PC への単方向 UDP 配信を前提にしています。

## 1. システム構成概要

- **制御ボード**: ugo Controller MCU。Feetech 系サーボ（ugoカスタム仕様）と Robotis DYNAMIXEL 系サーボを混在制御。
- **サーボ系統**: ugo Controller MCU から各サーボへ RS-485/RS-485 互換バスで指令。PC とは Ethernet を介した UDP 通信で状態共有。
- **監視 PC**: ugo_arm_monitor.py を常駐させ、MCU からの UDP を可視化。追加の制御アプリケーションがあれば同じデータを取り込める。

## 2. ネットワークおよびプロトコル設定

- **物理層/リンク**: 100BASE-TX 以上の Ethernet 直結（スイッチ経由可）。
- **プロトコル**: UDP（ユニキャスト）。文字コードは UTF-8。
- **ugo Controller MCU**
  - IP アドレス: `192.168.4.40`
  - 送信ポート: `8888`
- **PC（モニタ側） ugo_arm_monitor.pyが実行される環境**
  - IP アドレス: `192.168.4.10`
  - 受信ポート: `8886`
- **サブネットマスク**: `255.255.255.0`
- **周期**: `vsd,interval:10[ms],read:5[ms],write:1[ms]` の情報より、制御周期 10 ms、読み出しタイミング 5 ms、書き込み 1 ms を想定。

## 3. メッセージフレーム仕様（MCU → PC）

1 回の UDP ペイロードはテキスト行の集合（CSV形式）。基本構造は以下。

```
vsd,interval:10[ms],read:5[ms],write:1[ms]
id,11,12,13,14,15,16,17,1,2,3,4,5,6,7
agl,<id1角度>,<id2角度>,...
vel,<id1速度>,<id2速度>,...
cur,<id1電流>,<id2電流>,...          # 任意（送信されない実装もある）
onj_agl,<id1目標角度>,...             # 任意（目標角度を送る場合）
```

### 3.1 行ごとの意味

- **`vsd` 行**
  制御ループのメタ情報を記載。括弧内は ms 単位。値が可変の場合でもフォーマットは `key:value` の組をカンマ区切りで列挙する。
- **`id` 行**
  サーボ ID の送信順番。例では左腕（11〜17）→右腕（1〜7）の順。MCU 実装では、変更時に PC 側が追従できるよう最新の並びを常に送る。
- **`agl` 行**
  現在角度。単位は 0.1 度（Feetech／Robotis 共通）。PC 側では 10 で割って度表示。値が欠ける場合は空文字（連続の `,,`）で送信可。
- **`vel` 行**
  現在速度の生データ（Vsido 標準のカウント値）。単位変換が必要な場合は利用側で行う。
- **`cur` 行（任意）**
  現在トルク／電流の生データ。PDF では明確な記述が無いが、モニタスクリプトは受信時に同列として扱えるよう実装されている。
- **`onj_agl` 行（任意）**
  目標角度（0.1 度単位）。配信する場合のみ追加。未送信でも PC 側はスキップする。

すべての行は `\n` 区切り。MCU 側が複数行を 1 UDP パケットにまとめて送ることを前提とするが、パケット分割が起こっても PC 側はバッファリングして再構成する設計になっている。

### 3.2 送信タイミング

- 制御周期（10 ms）ごとに最新状態を送信。
- 瞬断対策として少なくとも 1 秒に 100 パケット程度の送信を継続。欠損時は PC 側で経過時間を監視。

## 4. メッセージフレーム仕様（PC → MCU）

PC から ugo Controller MCU へも同じ Ethernet/UDP チャネルを用いて姿勢指令を送る。送信先は ugo Controller MCU の固定 IP `192.168.4.40`、ポート `8888`。PC 側は同じインターフェースカードを用い、送信ポートは任意（推奨: `8886` を bind して双方向通信を維持）。

### 4.1 フレーム構成

MCU → PC と同じく CSV 行を複数連結したフォーマットを用いる。基本行は以下。

```
cmd,interval:10[ms],write:1[ms],mode:abs
id,11,12,13,14,15,16,17,1,2,3,4,5,6,7
tar,<id1目標角度0.1deg>,<id2目標角度0.1deg>,...
spd,<id1目標速度raw>,<id2目標速度raw>,...        # 任意
trq,<id1トルク上限raw>,<id2トルク上限raw>,...    # 任意
sync,<UNIX epoch[ms]>,<予備フィールド>             # 任意
```

- **`cmd` 行**
  制御ループの基本パラメータとモードを指定。`mode` は `abs`（絶対角度指令）または `rel`（相対指令）を想定。`interval`/`write` は MCU 側の目標ループ時間と一致させる。
- **`id` 行**
  送信対象ジョイントの順序。MCU → PC と同一である必要があるため、テレメトリ受信後に最新順序を流用する。
- **`tar` 行**
  ジョイント毎の絶対目標角度。単位は 0.1 度で、MCU 側の仕様に合わせて整数で送る。PC 内部では度（°）で扱い、送信前に 10 倍して丸める。
- **`spd` 行（任意）**
  速度フィードフォワードまたは最大速度制限を raw 値で指定。未送信の場合は MCU 既定値を使用。
- **`trq` 行（任意）**
  トルク／電流上限。フィールド数が少ない場合は残りジョイントに MCU 既定値が適用される。
- **`sync` 行（任意）**
  PC の時刻やコマンドシーケンス番号を伝える。MCU 側で遅延補償を行う場合に利用。

行末は `\n`。1 パケット内に収まらない場合でも MCU 側は行単位で再構成するため、パケット境界を跨いでも問題ない。

### 4.2 送信周期とリトライ

- PC 側アプリケーションは 10 ms 周期で `tar` を更新し、未変更時でもハートビートとして送信を継続する。
- 30 ms 以上返信（テレメトリ）が無い場合は `cmd` 行に `mode:hold` を設定し安全保持を要請する運用を推奨。
- 送信失敗時は即座にリトライし、N 回（例:3）失敗で通信断と判断し上位へ通知。

### 4.3 例

```
cmd,interval:10[ms],write:1[ms],mode:abs
id,11,12,13,14,15,16,17,1,2,3,4,5,6,7
tar,120,45,-30,0,0,0,0,10,10,10,10,10,10,10
spd,200,200,200,150,150,150,150,180,180,180,180,180,180,180
trq,1023,1023,1023,900,900,900,900,800,800,800,800,800,800,800
sync,1714440000000,1
```

上記ではジョイント 11〜17／1〜7 へ 0.1 度単位の絶対角度を送信し、速度・トルクの上限、シーケンス番号 `1` を付与している。

### 4.4 実装上の注意

- 角度の丸め誤差で MCU が振動しないよう、送信前に `round(value * 10)` を行い整数化する。
- `tar` 行の項目数が `id` と一致しない場合、MCU は残りを無視または 0 と解釈するため、常にフル長で送る。
- 双方向 UDP であるため PC は同一 NIC・サブネット (`255.255.255.0`) を維持し、送信パケットには最新の `id` 並びを埋め込む。
- モニタリングアプリと制御アプリが同一マシンの場合、ポート衝突を避けるため送信側は `SO_REUSEADDR` を有効化する。

## 5. PC 側モニタ (`ugo_arm_monitor.py`)

- **起動方法**: `python ugo_dual_arm/ugo_arm_monitor.py`
  オプション: `--host`（既定 `0.0.0.0`）、`--port`（既定 `8886`）、`--fps`（描画更新 20 Hz 標準）。
- **機能**:

  - UDP をノンブロッキング受信し、CSV を解析して最新値を保持。
  - `id` 行を受信するまで待機表示。受信後は ID 昇順でテーブル出力。
  - 角度は 0.1 度単位 → 度に換算。速度・トルクは生値表示。
  - `onj_agl` など未知の行が来ても無視できるよう拡張性を確保。
  - パケットが行途中で分割されても、次パケットと結合して解析（`partial_buf`）。
- **画面出力例**:

  ```
  ugo arm UDP Monitor |  Ctrl+C to exit
  Last packet: 2024-05-01 12:34:56  (age: 0.03s)

          ID |  Angle[deg] |    Vel(raw) |  Torque(raw)
           1 |        12.3 |          12 |           45
  ```

## 6. ugo Controller MCU実装上の注意

- `id`→`agl`→`vel`→`cur`…と固定順で送る。行数が増える場合でもヘッダ文字列で識別できるようにする。
- 数値は ASCII で送信（エンコード: UTF-8）。小数は `123`（0.1 度単位）または `123.0` など CSV として parse 可能な形式。
- 送信バッファが溢れないよう MTU（1500 byte）を超えないサイズにまとめる。ID 14 個で `agl/vel/cur` を送っても 1 パケット内に収まる想定。
- 同期が取れない場合に備えて、`vsd` 行の interval/read/write を現在の制御ループに合わせて更新すると PC 側で調整しやすい。
